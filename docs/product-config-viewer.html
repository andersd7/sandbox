<head>
  <title>Zafin Product Configuration Viewer</title>

  <!-- Bootstrap CSS for styling -->
  <!-- jQuery (required for Bootstrap) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Bootstrap JS (after jQuery) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Bootstrap Table and Filter Control JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.21.1/dist/bootstrap-table.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.21.1/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>

  <!-- Handlebars Library -->
  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/renderjson@1.3.0/renderjson.js"></script>

  <!-- Bootstrap Table and Filter Control CSS -->
  <link rel="stylesheet" href="https://cdn.rawgit.com/toni-heittola/js-datatable/v1.1.0/css.min/bootstrap-table-filter-control.min.css">

  <!-- Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.2/dist/bootstrap-table.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    </head>
    <body>
  
  <script>

    // Register partials dynamically
    Promise.all([
      loadPartial('product-name-template', 'hbs/product-name.hbs'),
      loadPartial('eligibility-template', 'hbs/eligibility.hbs'),
      loadPartial('deposit-product-config-template', 'hbs/deposit-product-config.hbs'),
      loadPartial('term-deposit-product-config-template', 'hbs/term-deposit-product-config.hbs'),
      loadPartial('lending-product-config-template', 'hbs/lending-product-config.hbs'),
      loadPartial('financial-parameters-template', 'hbs/financial-parameters.hbs'), 
      loadPartial('regulatory-parameters-template', 'hbs/regulatory-parameters.hbs'), 
      loadPartial('product-fees-template', 'hbs/product-fees.hbs'), 
      loadPartial('deposit-product-rateplan-template', 'hbs/deposit-product-rateplan.hbs'), 
      loadPartial('lending-product-rateplan-template', 'hbs/lending-product-rateplan.hbs'), 
      loadPartial('ratebased-offer-template', 'hbs/ratebased-offer.hbs'),
      loadPartial('services-template', 'hbs/services.hbs'),
      loadPartial('rategrid-template', 'hbs/rategrid.hbs'), 
      loadPartial('entitlements-template', 'hbs/entitlements.hbs'), 
      loadPartial('documentation-template','hbs/documentation.hbs'),
      loadPartial('open-banking-template', 'hbs/open-banking.hbs'),
      loadPartial('external-product-code-mapping-template', 'hbs/external-product-code-mapping.hbs'),
      loadPartial('impacted-systems-template', 'hbs/impacted-systems.hbs') 
    ]).then(() => {
      let productDetailsTpl = Handlebars.compile(document.getElementById('product-details-template').innerHTML)
    });

    let logConsole;
    // let selectedLeftProduct = null;
    // let selectedRightProduct = null;

    const BANKS = {
      prod: { name: 'PROD', json: 'datasets/prod.json'},
      preprod: { name: 'Pre-Prod', json: 'datasets/preprod.json'},
      sitk: { name: 'SIT-K', json: 'datasets/sitk.json'},
      sitl: { name: 'SIT-L', json: 'datasets/sitl.json'},
      st: { name: 'ST', json: 'datasets/st2.json'},
    }
    let savedBankId

    const PRODUCTS = {
      DEPOSIT: {
        name: 'Deposits',
      },
      TIME_DEPOSIT: {
        name: 'Term Deposits',
      },
        CREDIT_CARD: {
        name: 'Credit and Charge Cards',
      },
        MORTGAGE: {
        name: 'Residential Mortgages',
      },
      OFFERS: {
        name: 'Marketing Propositions',
      },
    }

    function logToConsole(msg) {
      console.log(msg)
      // logConsole.value += msg + '\n'
    }


    async function getProducts(bank) {
      let jsonUrl = `${bank.json}`; // Path to the JSON file
      try {
        logToConsole(`Getting products for ${bank.name}`);
        const start = new Date();
        let response = await fetch(jsonUrl);
        let jsonData = await response.json();
        const duration = (new Date() - start) / 1000;

        // Assuming you're interested in the first entry in the data array
        const res = jsonData.data && jsonData.data[0] ? {
          asofDate: jsonData.requestDate,
          count: jsonData.data[0].productDetails.length,
          products: jsonData.data[0].productDetails
        } : { asofDate: null, count: 0, products: [] };

        logToConsole(`Got products for ${bank.name} in ${duration}s`);
        console.log(res);
        return res;
      } catch (err) {
        logToConsole(`Error getting data for ${bank.name} from ${bank.json}`);
        console.error(err);
        return { products: [], count: 0 };
      }
    }

    function processProducts(products) {
      const byCategory = {};

      // Initialize categories in byCategory object
      for (let prodCat in PRODUCTS) {
        byCategory[prodCat] = { count: 0, products: [] };
      }

      products.forEach((p) => {
        const category = p.productClassification; // or the key you're using

        // Ensure the category exists in the PRODUCTS object
        if (category && PRODUCTS[category]) {
          byCategory[category].count++;
          byCategory[category].products.push(p);
        } else {
          console.warn(`Product ${p.productName} has an unknown or missing category: ${category}`);
        }
      });

      return byCategory;
    }

    async function toggleDiagram(productId) {
        const bankId = savedBankId;
        const diagramButton = document.getElementById('diagram-btn');

        if (diagramButton.textContent === 'Show Diagram') {
          const h2 = document.createElement('h2');
          // h2.style.color = 'blue';
          h2.textContent = 'Diagram is a placeholder and does not reflect actual product details';
          document.getElementById("product-details-diagram-content").appendChild(h2);
          const iframe = document.createElement('iframe');
          iframe.width = "80%";
          iframe.height = "500";
          iframe.frameBorder = "0";
          iframe.src = "https://gobravedave.github.io/sandbox/gojs-product.html";
          document.getElementById("product-details-diagram-content").appendChild(iframe);
          diagramButton.textContent = 'Hide Diagram';
        } else {
            document.getElementById("product-details-diagram-content").innerHTML = "";
            diagramButton.textContent = 'Show Diagram';
        }
    }

    async function toggleJson(productId) {
      logToConsole(`Showing JSON for bank ${savedBankId} productId ${productId}`)
      const jsonBtn = document.getElementById('json-btn');
      if (jsonBtn.textContent === 'Show JSON') {
        let productDetails = BANKS[savedBankId].productsRaw.find(prod => prod.productCode=== productId);

        var pre = document.getElementById("product-details-json-content");
        pre.innerHTML = ""; // Clear previous JSON content
        renderjson.set_icons('+', '-');
        renderjson.set_show_to_level(2);
        // renderjson.set_collapse_msg(function(len) { return len + " item" + (len==1 ? "" : "s") })
        pre.appendChild(renderjson(productDetails));
        jsonBtn.textContent = 'Hide JSON';
      } else {
        document.getElementById("product-details-json-content").innerHTML = "";
        jsonBtn.textContent = 'Show JSON';
      }
    }

    async function toggleCheck(productId) {
      logToConsole(`Showing Checker for bank ${savedBankId} productId ${productId}`)
      const checkBtn = document.getElementById('check-btn');
      if (checkBtn.textContent === 'Show Checker') {
        let productDetails = BANKS[savedBankId].productsRaw.find(prod => prod.productCode=== productId);

        var pre = document.getElementById("product-details-checker-content");
        pre.innerHTML = ""; // Clear previous Checker content
        const h2 = document.createElement('h2');
        // h2.style.color = 'blue';
        h2.textContent = 'Coming soon...';
        document.getElementById("product-details-checker-content").appendChild(h2);
        
        checkBtn.textContent = 'Hide Checker';
      } else {
        document.getElementById("product-details-checker-content").innerHTML = "";
        checkBtn.textContent = 'Show Checker';
      }
    }

    async function toggleCompare(productId) {
      logToConsole(`Showing Compare for bank ${savedBankId} productId ${productId}`)
      const compareBtn = document.getElementById('compare-btn');
      if (compareBtn.textContent === 'Show Compare') {
        let productDetails = BANKS[savedBankId].productsRaw.find(prod => prod.productCode=== productId);

        var pre = document.getElementById("product-details-compare-content");
        const compareWithSelect = document.getElementById("compare-with");
        compareWithSelect.style.display = "block";
        populateCompareDropdown();
        pre.innerHTML = ""; // Clear previous Compare content
        const h2 = document.createElement('h2');
        // h2.style.color = 'blue';
        h2.textContent = 'Also coming soon...';
        document.getElementById("product-details-compare-content").appendChild(h2);
        compareBtn.textContent = 'Hide Compare';
      } else {
        document.getElementById("product-details-compare-content").innerHTML = "";
        document.getElementById("compare-with").style.display = "none";
        compareBtn.textContent = 'Show Compare';
      }
    }

    function populateCompareDropdown() {
      const $compareDropdown = document.getElementById('compare-with');
      if ($compareDropdown) {
        // Clear previous options first to avoid duplication
        $compareDropdown.innerHTML = '<option value="">Compare with</option>';

        for (const key in BANKS) {
          if (BANKS.hasOwnProperty(key)) {
            const option = document.createElement('option');
            option.value = key; // Use the key as the value
            option.textContent = BANKS[key].name; // Use the name property as the display text
            $compareDropdown.appendChild(option);
          }
        }
      }
    }

    function loadPartial(name, path) {
      return fetch(path)
      .then(response => response.text())
      .then(templateContent => {
        Handlebars.registerPartial(name, templateContent);
      })
      .catch(error => console.error(`Error loading partial ${name}: ${error}`));
    }

    
    window.onload = async function () {

    Handlebars.logger.level = 0; // for DEBUG
    // Register helpers
    Handlebars.registerHelper('formatDate', function(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-AU');
    });

    let tableIndex = 0; // Global counter for table IDs
    Handlebars.registerHelper('uniqueTableId', function() {
      return `table-${tableIndex++}`;
    });

    // Register a Handlebars helper to execute JavaScript code after rendering
    Handlebars.registerHelper('initializeTable', function() {
    // After the DOM is updated, initialize each table separately
      setTimeout(() => {
        $('[id^=table-]').each(function() {
          const tableId = $(this).attr('id');
          $('#' + tableId).bootstrapTable(); // Initialize the Bootstrap Table
        });
      }, 100);
    });

      let productListTpl = Handlebars.compile(document.getElementById('products-list-template').innerHTML)
      const $productsList = document.getElementById('products-list')

      $productsList.innerHTML = productListTpl({})
      let productDetailsTpl = Handlebars.compile(document.getElementById('product-details-template').innerHTML)

      // logConsole = document.getElementById('log-console')

      await Promise.all(Object.entries(BANKS).map(async ([id, bank]) => {
        BANKS[id].id = id
        for (let prodCat in PRODUCTS) {
          PRODUCTS[prodCat].banks = PRODUCTS[prodCat].banks || {}
          PRODUCTS[prodCat].banks[id] = {
            bankId: id,
          }
        }

        const { asofDate, count, products } = await getProducts(bank)
        BANKS[bank.id].productsRaw = products
        BANKS[bank.id].totalCount = count
        BANKS[bank.id].asofDate = asofDate

        // add banks product count and list to PRODUCTS
        const byCategory = processProducts(products)
        for (let prodCat in PRODUCTS) {
          PRODUCTS[prodCat].banks[bank.id].count = byCategory[prodCat].count
          PRODUCTS[prodCat].banks[bank.id].products = byCategory[prodCat].products
        }

        $productsList.innerHTML = productListTpl({ BANKS, PRODUCTS })
      }))
      logToConsole('Processed products from all banks')
      console.log({ BANKS, PRODUCTS })

      $productsList.innerHTML = productListTpl({ BANKS, PRODUCTS })

      let $catRows = document.querySelectorAll('.category-row')
      for (let $catRow of $catRows) {
        // clicking on category row will show all products of that category
        $catRow.addEventListener('click', function (e) {
          let { catId } = e.target.parentNode.dataset
          let $catProdsEl = document.querySelector(`#products-${catId}`)
          $catRow.classList.toggle('expanded')
          $catProdsEl.classList.toggle('hidden')
        })
      }

      let $prodNames = document.querySelectorAll('.product-name')
      for (let $prodName of $prodNames) {
        // clicking on product name will show product details
        $prodName.addEventListener('click', async function (e) {
          let { bankId, productCode } = e.target.dataset
          savedBankId = bankId
          document.getElementById('product-details').innerHTML = '<div id="product-details-content">Fetching product details...<span id="product-details-close">&times;</span></div>'
          document.getElementById('product-details').style.display = 'block'
          document.getElementById('product-details-close').addEventListener('click', function (e) {
            document.getElementById('product-details').style.display = 'none'
            document.getElementById('product-details').innerHTML = ''
          })

          let productDetails = BANKS[bankId].productsRaw.find(prod => prod.productCode === productCode);
          console.log({productDetails})

          // Compile the main product template

          if (productDetails) {
            document.getElementById('product-details').innerHTML = productDetailsTpl({ product: productDetails, asofDate: BANKS[bankId].asofDate, place: BANKS[bankId].name });
          } else {
            document.getElementById('product-details').innerHTML = `<div id="product-details-content">Product details not found.<span id="product-details-close">&times;</span></div>`;
          }

          document.getElementById('product-details-close').addEventListener('click', function (e) {
            document.getElementById('product-details').style.display = 'none'
            document.getElementById('product-details').innerHTML = ''
          })
        })
      }

    }

  // Add event listener to all headings
  document.addEventListener('click', function(event) {
    if (event.target.tagName.match(/H[1-4]/i)) {
      // Toggle visibility of the next element (content)
      const nextContent = event.target.nextElementSibling;
      if (nextContent && nextContent.classList.contains('content')) {
        nextContent.style.display = nextContent.style.display === 'none' ? 'block' : 'none';
      }
    }
  });

    </script>

    <h1>Zafin Product Configuration Viewer</h1>
    <div style="border-radius: 10px; border: 1px solid #212e01; padding: 10px; background-color: #acc8f1;margin-left: 5px;margin-right: 5px;">
    <h4>About this page</h4>
    <div class="content">
    <ul style="list-style: square; padding-left: 10px;">
      <li>This page is a static view of the product configurations from each Zafin environment. The data will be periodically updated as part of a product configuration relaese or upon request to <a href="mailto:david.anderson@anz.com">david.anderson@anz.com</a></li>
      <li>To use.. Click on a product category to show products in each environment. Click on a product button to show the product details.</li>
      <li>Known data gaps include multiuse product fees, rulesets, offers, credit card config etc</li>
      <li>Backlog items include calling mulesoft to pull product data, compare, config checker, diagram view</li>
    </ul>
    </div>
    </div>
    <br>

    <!-- <textarea id="log-console" style="height: 100px; width: 500px;"></textarea> -->
    <div id="products-list"></div>
    <div id="product-details"></div>

<!-- Main Product Template -->
<script id="product-details-template" type="text/x-handlebars-template">
  <div id="product-details-content">
    <button id="diagram-btn" onclick="toggleDiagram( '{{product.productCode}}')" >Show Diagram</button>
    <button id="json-btn" onclick="toggleJson( '{{product.productCode}}')">Show JSON</button>
    <button id="check-btn" onclick="toggleCheck( '{{product.productCode}}')">Show Checker</button>
    <button id="compare-btn" onclick="toggleCompare( '{{product.productCode}}')">Show Compare</button>
    <span id="product-details-close">&times;</span>
    <div><pre id="product-details-diagram-content"></pre></div>
    <div><pre id="product-details-json-content"></pre></div>
    <div><pre id="product-details-checker-content"></pre></div>
    <div><pre id="product-details-compare-content"></pre>
      <select id="compare-with" style="width: 200px; display: none">
        <option value="">Compare with Bank</option>
      </select>
  
    </div>

  {{> product-name-template}}

  <h2>Eligibility</h2>
  <div class="content">
  {{#with product.productEligibilityDetails}}
  {{> eligibility-template}}
  {{/with}}
  </div>

  {{#if product.productConfiguration}}
    <h2>Deposit Product Configuration</h2>
    <div class="content">
    <div class="table_wrapper">
        {{> deposit-product-config-template}}
    </div>
    </div>
  {{/if}}

  {{#if product.termDepositProductConfiguration}}
  <h2>Term Deposit Product Configuration</h2>
  <div class="content">
  <div class="table_wrapper">
      {{> term-deposit-product-config-template}}
  </div>
  </div>  
  {{/if}}

  {{#if product.mortgageProductConfiguration}}
    <h2>Lending Product Configuration</h2>
    <div class="content">
    <div class="table_wrapper">
    {{> lending-product-config-template}}
    </div>
    </div>
  {{/if}}

  {{#if product.feePlans}}
    <h2>Fee Plans</h2>
    <div class="content">
    <div class="table_wrapper">
    {{> product-fees-template}}
    </div>
    </div>
  {{/if}}

  {{> deposit-product-rateplan-template}}
  {{> lending-product-rateplan-template}}

  {{#if product.serviceAssociation}}
  <h2>Associated Services</h2>
  <div class="content">
  <div class="table_wrapper">    
  {{> services-template}}
  </div>
  </div>  
  {{/if}}

  {{#if product.openBankingConfiguration}}
  <h2>Open Banking</h2>
  <div class="content">
  <div class="table_wrapper">
      {{> open-banking-template}}
  </div>
  </div>
  {{/if}}

  {{#if product.externalProductCodeMapping}}
  <h2>External Product Code Mapping</h2>
  <div class="content">
  <div class="table_wrapper">
  {{> external-product-code-mapping-template}}
  </div>
  </div> 
  {{/if}}

  {{#if product.impactedSystems}}
    <h2>Impacted Systems</h2>
    <div class="content">
    <div class="table_wrapper">
    {{> impacted-systems-template}}
    </div>
    </div>
  {{/if}}
</div>
</script>

  <script id="products-list-template" type="text/x-handlebars-template">
    <table style="width: 100%">
      <tr>
        <th>Environment</th>
        {{#each BANKS}}
          <th>{{this.name}}</th>
        {{/each}}
      </tr>
      <tr>
        <td>Total Products</td>
        {{#each BANKS}}
          <td>{{this.totalCount}}</td>
        {{/each}}
      </tr>
      {{#each PRODUCTS}}
        <tr class="category-row" data-cat-id="{{@key}}">
          <td class="category-title">{{this.name}}</td>
          {{#each this.banks}}
            <td>{{this.count}}</td>
          {{/each}}
        </tr>
        <tr class="category-products-list hidden" id="products-{{@key}}">
          <td></td>
          {{#each this.banks}}
            <td class="category-products-main">
              <table>
                {{#each this.products}}
                  <tr>
                    <td>
                      <button class="product-name" data-bank-id="{{../bankId}}" data-product-code="{{this.productCode}}" title="{{this.productDescription}}">{{this.productName}}</button>
                    </td>
                  </tr>
                {{/each}}
              </table>
            </td>
          {{/each}}
        </tr>
      {{/each}}
  </table>
  </script>

  <style>
    body {
      font-family: Arial;
    }

    h1, h2, h3, h4 {
      padding-top: 12px;
      cursor: pointer;
      color: #371282;
    }
    .content {
        display: block;
        margin-left: 20px;
    }

   .table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
    }

    .flex-container {
      display: flex;
      flex-wrap: wrap;
    }

  .flex-container > div {
    width: 200px;
    margin: 10px;
    padding: 10px;
  }

/* Optional tooltip styling */
.table th[title]:hover, 
.table td[title]:hover {
  position: relative;
  cursor: pointer; /* Optional: add cursor pointer on hover */
}

.table th[title]:hover:after, 
.table td[title]:hover:after {
  content: attr(title);
  position: absolute;
  background-color: #333;
  color: #fff;
  padding: 5px 10px;
  border-radius: 5px;
  white-space: nowrap;
  top: -30px; /* Position above the element */
  left: 50%; /* Center tooltip */
  transform: translateX(-50%);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 1;
}

.table th[title]:hover:after, 
.table td[title]:hover:after {
  opacity: 1;
}

    .table th, .table td {
      word-wrap: break-word;
      white-space: normal !important; /* Allow text to wrap */;
      width: 100px; /* Set this based on your requirement */
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis; /* Add ellipsis for overflow text */
    }

    table {
      border-collapse: collapse;
    }

    th {
      background: #eee;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      /* text-align: center; */
      vertical-align: top;
      font-size: 14px;
    }

    select {
    font-family: Arial, sans-serif;
    font-size: 14px;
    padding: 10px 15px;
    margin: 5px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    background-color: #f7f7f7;
    cursor: pointer;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }

select:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 6px rgba(0, 123, 255, 0.5);
}

select:hover {
  background-color: #eaeaea;
}

select:disabled {
  background-color: #e0e0e0;
  cursor: not-allowed;
}

select {
  width: auto;
  min-width: 200px;
  max-width: 100%;
}

    button {
      background-color: white;
      color: #3949ab;
      border: 1px solid #3949ab;
      border-radius: 8px;
      padding: 10px 20px;
      transition-duration: 0.4s;
    }

    button[disabled]:hover {
      background: red;
    }

    button:hover {
    background-color: #3949ab; /* purple */
    color: white;
  }
    .category-row.expanded {
      background-color: #eee;
    }
    .category-row:hover {
      background-color: #eee;
    }
    .category-title {
      cursor: pointer;
      width: 200px;
    }

    .product-name {
      cursor: pointer;
    }

    .category-products-main {
      padding: 0;
    }
    .category-products-main table {
      width: 100%;
    }
    .category-products-main table td {
      border: 0;
    }
    .category-products-list.hidden {
      display: none;
    }


    #product-details {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgb(0,0,0); /* Fallback color */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    #product-details-content {
      background-color: #fefefe;
      margin: 50px auto; /* 15% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      width: 80%; /* Could be more or less, depending on screen size */
    }
    #product-details-close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    #product-details-close:hover,
    #product-details-close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .thead-dark th {
      background: #eee;
    }

  </style>

  </body>
  </html>